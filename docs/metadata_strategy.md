# å…ƒè³‡æ–™ç­–ç•¥:å¹³è¡¡å‘é‡æª¢ç´¢èˆ‡çµæœå±•ç¤º

## å•é¡Œé™³è¿°

**çŸ›ç›¾:**
- **å‘é‡æª¢ç´¢æ™‚:** å…ƒè³‡æ–™(URLã€ç·¨è™Ÿã€æŠ“å–æ™‚é–“)æ˜¯å™ªéŸ³,é™ä½æª¢ç´¢æ•ˆæœ
- **çµæœé¡¯ç¤ºæ™‚:** é€™äº›å…ƒè³‡æ–™æ˜¯å¿…è¦çš„,ç”¨æ–¼å¼•ç”¨ã€è¿½è¹¤ã€é©—è­‰

**ç¯„ä¾‹:**
```
è©³ç´°é é¢: https://www.fsc.gov.tw/ch/home.jsp?id=131&parentpath=0,2&mcustomize=...
è³‡æ–™æŠ“å–æ™‚é–“: 2025-11-10 20:44:18
ç·¨è™Ÿ: 323
```

é€™äº›è³‡è¨Š:
- âŒ å°å‘é‡æª¢ç´¢ç„¡å¹«åŠ© (ç”šè‡³æœ‰å®³)
- âœ… å°çµæœå±•ç¤ºå¿…è¦ (citeã€è¿½è¹¤ã€é©—è­‰)

---

## âœ… è§£æ±ºæ–¹æ¡ˆ A: Gemini File API Metadata (æ¨è–¦)

### æ¦‚å¿µ

Gemini File API å…è¨±ç‚ºæª”æ¡ˆé™„åŠ  **metadata**,é€™äº› metadata:
- âŒ **ä¸æœƒè¢«å‘é‡åŒ–** (ä¸å½±éŸ¿æª¢ç´¢)
- âœ… **æœƒéš¨æŸ¥è©¢çµæœè¿”å›** (å¯ç”¨æ–¼é¡¯ç¤º)

### å¯¦ä½œæ–¹å¼

**ä¸Šå‚³æª”æ¡ˆæ™‚é™„åŠ  metadata:**

```python
from google import genai
from google.genai import types

client = genai.Client(api_key=api_key)

# 1. ä¸Šå‚³ä¹¾æ·¨çš„å…§å®¹ (åªåŒ…å«æŸ¥è©¢ç›¸é—œè³‡è¨Š)
clean_content = """
ç™¼æ–‡æ—¥æœŸ: 2020-05-19
ä¾†æºå–®ä½: ä¿éšªå±€
æ©Ÿæ§‹åç¨±: å‡±åŸºå•†æ¥­éŠ€è¡Œè‚¡ä»½æœ‰é™å…¬å¸
ç½°æ¬¾é‡‘é¡: 60 è¬å…ƒ

---

å‡±åŸºå•†æ¥­éŠ€è¡Œè‚¡ä»½æœ‰é™å…¬å¸å› é•åä¿éšªæ³•...
ä¸€ã€è£ç½°æ™‚é–“ï¼š109å¹´5æœˆ19æ—¥
äºŒã€å—è£ç½°ä¹‹å°è±¡ï¼šå‡±åŸºå•†æ¥­éŠ€è¡Œè‚¡ä»½æœ‰é™å…¬å¸
...
"""

# 2. é™„åŠ  metadata (ä¸æœƒè¢«å‘é‡åŒ–)
file = client.files.upload(
    path='penalty_323.txt',
    config=types.UploadFileConfig(
        display_name='2020-05-19_ä¿éšªå±€_å‡±åŸºå•†æ¥­éŠ€è¡Œ',
        mime_type='text/plain'
    )
)

# 3. æ‰‹å‹•ç®¡ç† metadata æ˜ å°„
metadata_mapping = {
    file.name: {
        'id': '323',
        'url': 'https://www.fsc.gov.tw/ch/home.jsp?...',
        'crawl_time': '2025-11-10 20:44:18',
        'title': 'å‡±åŸºå•†æ¥­éŠ€è¡Œè‚¡ä»½æœ‰é™å…¬å¸å› é•åä¿éšªæ³•...',
        'gemini_file_id': file.name,
        'gemini_file_uri': file.uri
    }
}

# å„²å­˜åˆ° file_mapping.json
with open('data/file_mapping.json', 'w') as f:
    json.dump(metadata_mapping, f, ensure_ascii=False, indent=2)
```

**æŸ¥è©¢æ™‚å–å¾— metadata:**

```python
# æŸ¥è©¢
response = client.models.generate_content(
    model='gemini-2.0-flash-exp',
    contents='è‘£äº‹å‡ºå·®å ±éŠ·ç¼ºå¤±',
    config=types.GenerateContentConfig(
        tools=[
            types.Tool(
                file_search=types.FileSearch(
                    file_search_store_names=[store_name]
                )
            )
        ]
    )
)

# æå–å¼•ç”¨çš„æª”æ¡ˆ
if response.candidates[0].grounding_metadata:
    for chunk in response.candidates[0].grounding_metadata.grounding_chunks:
        file_uri = chunk.retrieved_context.uri

        # å¾ file_mapping.json å–å¾—å®Œæ•´ metadata
        metadata = metadata_mapping.get(file_uri)

        print(f"å¼•ç”¨ä¾†æº: {metadata['title']}")
        print(f"åŸå§‹é€£çµ: {metadata['url']}")
        print(f"æŠ“å–æ™‚é–“: {metadata['crawl_time']}")
```

### å„ªé»

- âœ… **å‘é‡æª¢ç´¢æ•ˆæœæœ€ä½³** (ä¹¾æ·¨å…§å®¹,ç„¡å™ªéŸ³)
- âœ… **å®Œæ•´çš„ metadata å¯ç”¨** (å„²å­˜åœ¨ file_mapping.json)
- âœ… **éˆæ´»æ€§é«˜** (å¯å„²å­˜ä»»æ„ metadata)
- âœ… **ä¸å¢åŠ æª”æ¡ˆå¤§å°** (metadata åˆ†é›¢å„²å­˜)

### ç¼ºé»

- âš ï¸ éœ€è¦ç¶­è­· `file_mapping.json` (Gemini file ID â†’ metadata)
- âš ï¸ æŸ¥è©¢å¾Œéœ€è¦é¡å¤–æŸ¥æ‰¾ metadata

---

## è§£æ±ºæ–¹æ¡ˆ B: é›™æª”æ¡ˆç­–ç•¥

### æ¦‚å¿µ

ç‚ºæ¯å€‹è£ç½°æ¡ˆä»¶ç”Ÿæˆå…©å€‹ç‰ˆæœ¬:
1. **æª¢ç´¢ç‰ˆ (ä¸Šå‚³ Gemini):** ä¹¾æ·¨å…§å®¹,ç„¡å™ªéŸ³
2. **é¡¯ç¤ºç‰ˆ (æœ¬åœ°ä¿å­˜):** å®Œæ•´å…§å®¹,å«æ‰€æœ‰ metadata

### æª”æ¡ˆçµæ§‹

```
data/
â”œâ”€â”€ plaintext_for_rag/           # ä¸Šå‚³åˆ° Gemini (æª¢ç´¢ç”¨)
â”‚   â””â”€â”€ 323.txt                  # ä¹¾æ·¨ç‰ˆæœ¬
â”œâ”€â”€ plaintext_full/              # æœ¬åœ°ä¿å­˜ (é¡¯ç¤ºç”¨)
â”‚   â””â”€â”€ 323_full.txt             # å®Œæ•´ç‰ˆæœ¬
â””â”€â”€ file_mapping.json            # æ˜ å°„é—œä¿‚
```

### æª”æ¡ˆå…§å®¹å°æ¯”

**æª¢ç´¢ç‰ˆ (ä¸Šå‚³ Gemini):**
```
ç™¼æ–‡æ—¥æœŸ: 2020-05-19
ä¾†æºå–®ä½: ä¿éšªå±€
æ©Ÿæ§‹åç¨±: å‡±åŸºå•†æ¥­éŠ€è¡Œè‚¡ä»½æœ‰é™å…¬å¸
ç½°æ¬¾é‡‘é¡: 60 è¬å…ƒ

---

å‡±åŸºå•†æ¥­éŠ€è¡Œè‚¡ä»½æœ‰é™å…¬å¸å› é•åä¿éšªæ³•...
ä¸€ã€è£ç½°æ™‚é–“ï¼š109å¹´5æœˆ19æ—¥
...
```

**é¡¯ç¤ºç‰ˆ (æœ¬åœ°):**
```
æ–‡ä»¶ç·¨è™Ÿ: 323
ç™¼æ–‡æ—¥æœŸ: 2020-05-19
ä¾†æºå–®ä½: ä¿éšªå±€
æ©Ÿæ§‹åç¨±: å‡±åŸºå•†æ¥­éŠ€è¡Œè‚¡ä»½æœ‰é™å…¬å¸
ç½°æ¬¾é‡‘é¡: 60 è¬å…ƒ
åŸå§‹é€£çµ: https://www.fsc.gov.tw/ch/home.jsp?...
è³‡æ–™æŠ“å–æ™‚é–“: 2025-11-10 20:44:18
æ¨™é¡Œ: å‡±åŸºå•†æ¥­éŠ€è¡Œè‚¡ä»½æœ‰é™å…¬å¸å› é•åä¿éšªæ³•...

---

å‡±åŸºå•†æ¥­éŠ€è¡Œè‚¡ä»½æœ‰é™å…¬å¸å› é•åä¿éšªæ³•...
...
```

### file_mapping.json

```json
{
  "323": {
    "gemini_file_id": "files/abc123",
    "gemini_file_uri": "https://generativelanguage.googleapis.com/...",
    "rag_file_path": "data/plaintext_for_rag/323.txt",
    "full_file_path": "data/plaintext_full/323_full.txt",
    "metadata": {
      "id": "323",
      "date": "2020-05-19",
      "source": "ä¿éšªå±€",
      "institution": "å‡±åŸºå•†æ¥­éŠ€è¡Œè‚¡ä»½æœ‰é™å…¬å¸",
      "url": "https://www.fsc.gov.tw/...",
      "crawl_time": "2025-11-10 20:44:18",
      "title": "å‡±åŸºå•†æ¥­éŠ€è¡Œè‚¡ä»½æœ‰é™å…¬å¸å› é•åä¿éšªæ³•..."
    }
  }
}
```

### å„ªé»

- âœ… å‘é‡æª¢ç´¢æ•ˆæœæœ€ä½³
- âœ… å®Œæ•´ metadata éš¨æ™‚å¯ç”¨
- âœ… æ¸…æ™°çš„é—œæ³¨é»åˆ†é›¢

### ç¼ºé»

- âš ï¸ å„²å­˜ç©ºé–“å¢åŠ  (å…©å€‹ç‰ˆæœ¬)
- âš ï¸ éœ€è¦ç¶­è­·å…©å€‹æª”æ¡ˆ

---

## è§£æ±ºæ–¹æ¡ˆ C: æª”æ¡ˆå…§åˆ†é›¢ (ä¸æ¨è–¦)

### æ¦‚å¿µ

åœ¨åŒä¸€å€‹æª”æ¡ˆä¸­,å°‡ metadata æ”¾åœ¨ç‰¹æ®Šå€å¡Š:

```
ç™¼æ–‡æ—¥æœŸ: 2020-05-19
ä¾†æºå–®ä½: ä¿éšªå±€
æ©Ÿæ§‹åç¨±: å‡±åŸºå•†æ¥­éŠ€è¡Œè‚¡ä»½æœ‰é™å…¬å¸
ç½°æ¬¾é‡‘é¡: 60 è¬å…ƒ

---

å‡±åŸºå•†æ¥­éŠ€è¡Œè‚¡ä»½æœ‰é™å…¬å¸å› é•åä¿éšªæ³•...
...

<!-- METADATA (è«‹å‹¿ç´¢å¼•)
ç·¨è™Ÿ: 323
åŸå§‹é€£çµ: https://www.fsc.gov.tw/...
è³‡æ–™æŠ“å–æ™‚é–“: 2025-11-10 20:44:18
-->
```

### å•é¡Œ

- âŒ **Gemini File Search æœƒç´¢å¼•æ•´å€‹æª”æ¡ˆ** (åŒ…æ‹¬ metadata å€å¡Š)
- âŒ ç„¡æ³•å‘Šè¨´ Gemini "å¿½ç•¥æŸå€‹å€å¡Š"
- âŒ metadata ä»ç„¶æœƒå½±éŸ¿å‘é‡æª¢ç´¢

**çµè«–:** ä¸å¯è¡Œ

---

## ğŸ“Š æ–¹æ¡ˆå°æ¯”

| æ–¹æ¡ˆ | å‘é‡æª¢ç´¢æ•ˆæœ | Metadata å¯ç”¨æ€§ | å¯¦ä½œè¤‡é›œåº¦ | å„²å­˜æˆæœ¬ | æ¨è–¦ |
|------|-------------|----------------|-----------|---------|------|
| **A: File API Metadata** | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­ | â­â­â­â­â­ | âœ… |
| **B: é›™æª”æ¡ˆ** | â­â­â­â­â­ | â­â­â­â­â­ | â­â­ | â­â­â­ | â­ |
| **C: æª”æ¡ˆå…§åˆ†é›¢** | â­â­ | â­â­â­â­ | â­â­â­â­ | â­â­â­â­â­ | âŒ |

---

## âœ… æ¨è–¦æ–¹æ¡ˆ:A (File API Metadata)

### ç‚ºä»€éº¼?

1. **æœ€ä½³çš„å‘é‡æª¢ç´¢æ•ˆæœ**
   - ä¸Šå‚³æª”æ¡ˆåªåŒ…å«æŸ¥è©¢ç›¸é—œå…§å®¹
   - é›¶ metadata å™ªéŸ³

2. **å®Œæ•´çš„ Metadata ç®¡ç†**
   - é€šé `file_mapping.json` é›†ä¸­ç®¡ç†
   - éˆæ´»,å¯å„²å­˜ä»»æ„ metadata

3. **æˆæœ¬æ•ˆç›Š**
   - ä¸éœ€è¦é‡è¤‡å„²å­˜æª”æ¡ˆ
   - file_mapping.json ç›¸å°è¼ƒå° (~5MB for 500 files)

4. **å·²æœ‰å¯¦è¸**
   - FSC-Penalties-Deploy å·²ç¶“åœ¨ä½¿ç”¨é¡ä¼¼æ©Ÿåˆ¶
   - åªéœ€æ“´å…… file_mapping.json çš„å…§å®¹

---

## ğŸ”§ å¯¦ä½œå»ºè­°

### file_mapping.json çµæ§‹è¨­è¨ˆ

```json
{
  "fsc_pen_20200519_0323": {
    "gemini_id": "files/abc123",
    "gemini_uri": "https://generativelanguage.googleapis.com/...",
    "display_name": "2020-05-19_ä¿éšªå±€_å‡±åŸºå•†æ¥­éŠ€è¡Œ",
    "metadata": {
      "id": "323",
      "date": "2020-05-19",
      "source": "ä¿éšªå±€",
      "institution": "å‡±åŸºå•†æ¥­éŠ€è¡Œè‚¡ä»½æœ‰é™å…¬å¸",
      "penalty_amount": "60è¬å…ƒ",
      "url": "https://www.fsc.gov.tw/...",
      "crawl_time": "2025-11-10 20:44:18",
      "title": "å‡±åŸºå•†æ¥­éŠ€è¡Œè‚¡ä»½æœ‰é™å…¬å¸å› é•åä¿éšªæ³•ç›¸é—œæ³•ä»¤...",
      "doc_number": "é‡‘ç®¡ä¿å£½å­—ç¬¬xxxè™Ÿ",
      "legal_basis": [
        "ä¿éšªæ³•ç¬¬167æ¢ä¹‹2è¦å®š"
      ]
    },
    "file_path": "data/plaintext_for_rag/323.txt",
    "file_size": 2856
  }
}
```

### å‰ç«¯é¡¯ç¤ºæµç¨‹

```python
# 1. æŸ¥è©¢ Gemini File Search
response = query_gemini(user_query)

# 2. æå–å¼•ç”¨çš„æª”æ¡ˆ
cited_files = extract_citations(response)

# 3. å¾ file_mapping.json å–å¾— metadata
for file in cited_files:
    metadata = file_mapping[file.name]['metadata']

    # 4. é¡¯ç¤ºå¼•ç”¨ä¾†æº
    display_citation(
        title=metadata['title'],
        date=metadata['date'],
        source=metadata['source'],
        institution=metadata['institution'],
        url=metadata['url'],  # â† åŸå§‹é€£çµä½œç‚º cite
        gemini_uri=file_mapping[file.name]['gemini_uri']
    )
```

### é¡¯ç¤ºç¯„ä¾‹

```
ğŸ“„ å¼•ç”¨ä¾†æº:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

æ¨™é¡Œ: å‡±åŸºå•†æ¥­éŠ€è¡Œè‚¡ä»½æœ‰é™å…¬å¸å› é•åä¿éšªæ³•ç›¸é—œæ³•ä»¤...
æ—¥æœŸ: 2020-05-19
ä¾†æº: ä¿éšªå±€
æ©Ÿæ§‹: å‡±åŸºå•†æ¥­éŠ€è¡Œè‚¡ä»½æœ‰é™å…¬å¸
ç½°æ¬¾: 60 è¬å…ƒ

ğŸ”— åŸå§‹é€£çµ: https://www.fsc.gov.tw/ch/home.jsp?...
ğŸ“‹ ç™¼æ–‡å­—è™Ÿ: é‡‘ç®¡ä¿å£½å­—ç¬¬xxxè™Ÿ

[æŸ¥çœ‹å®Œæ•´å…§å®¹]  [ä¸‹è¼‰ PDF]
```

---

## ğŸ“ˆ å„ªåŒ–å¾Œçš„å®Œæ•´æ¶æ§‹

```
æª¢ç´¢å±¤ (Gemini File Search):
  - ä¹¾æ·¨çš„ plain text (åªåŒ…å«æŸ¥è©¢ç›¸é—œå…§å®¹)
  - æª”æ¡ˆå¤§å°: 2.5-4KB
  - èªç¾©å¯†åº¦: æ¥µé«˜
  - å‘é‡åŒ–æ•ˆæœ: æœ€ä½³

æ˜ å°„å±¤ (file_mapping.json):
  - Gemini file ID â†’ Metadata æ˜ å°„
  - åŒ…å«æ‰€æœ‰å±•ç¤ºæ‰€éœ€è³‡è¨Š
  - æª”æ¡ˆå¤§å°: ~5MB (500 files)

é¡¯ç¤ºå±¤ (å‰ç«¯):
  - å¾ file_mapping.json å–å¾— metadata
  - æä¾›åŸå§‹é€£çµã€æ¨™é¡Œã€æ—¥æœŸç­‰
  - æ ¼å¼åŒ–é¡¯ç¤ºå¼•ç”¨ä¾†æº
```

---

## ğŸ¯ ç¸½çµ

**æ¨è–¦æ–¹æ¡ˆ:** File API Metadata (æ–¹æ¡ˆ A)

**æ ¸å¿ƒåŸå‰‡:**
- âœ… **æª¢ç´¢æ™‚:** åªç”¨ä¹¾æ·¨å…§å®¹ (æœ€ä½³å‘é‡åŒ–æ•ˆæœ)
- âœ… **é¡¯ç¤ºæ™‚:** å¾ file_mapping.json å–å¾—å®Œæ•´ metadata
- âœ… **é—œæ³¨é»åˆ†é›¢:** æª¢ç´¢ vs é¡¯ç¤º,å„å¸å…¶è·

**é æœŸæ•ˆæœ:**
- å‘é‡æª¢ç´¢æ•ˆæœ: â­â­â­â­â­ (ç„¡å™ªéŸ³å¹²æ“¾)
- Metadata å¯ç”¨æ€§: â­â­â­â­â­ (å®Œæ•´è³‡è¨Š)
- ä½¿ç”¨è€…é«”é©—: â­â­â­â­â­ (æœ‰åŸå§‹é€£çµ cite)

**å¯¦ä½œæˆæœ¬:** ä¸­ç­‰
- éœ€æ“´å…… file_mapping.json
- å‰ç«¯éœ€æ•´åˆ metadata é¡¯ç¤º
- ä½†æ¶æ§‹æ¸…æ™°,æ˜“æ–¼ç¶­è­·

---

**å ±å‘Šæ—¥æœŸ:** 2025-11-18
**å»ºè­°æ–¹æ¡ˆ:** File API Metadata + file_mapping.json
**é—œéµå„ªå‹¢:** å®Œç¾å¹³è¡¡æª¢ç´¢æ•ˆæœèˆ‡é¡¯ç¤ºéœ€æ±‚
