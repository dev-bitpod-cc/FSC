# 法令函釋爬取策略分析

## 分析目標

針對金管會「法令函釋」（NewsLaw）的各種類型，分析：
1. **是否需要爬取和上傳建索引？**
2. **對 RAG 查詢的價值如何？**
3. **應該上傳什麼內容？**（避免重複和索引噪音）
4. **本地 mapping 應該儲存什麼 metadata？**

## 關鍵發現（2025-11-20）

### ⚠️ Gemini File API 限制
- **不支援獨立的 metadata 儲存**（不索引但可查詢）
- **所有上傳的內容都會被索引**
- **策略**：只上傳實質內容（PDF），metadata 儲存在本地 `law_interpretations_mapping.json`

### 📊 現有架構參考
參考 FSC-Penalties-Deploy 專案的實作：
- 上傳內容到 Gemini → 獲得 `gemini_id`
- 本地維護 `file_mapping.json`（5.4 MB，495 筆）
- 前端查詢時：Gemini 檢索 → 取得 file_id → 查詢 mapping → 顯示結果

---

## 類型 1：修正型函釋 ⭐⭐⭐⭐⭐

### 基本資訊
- **頻率**：37%（約 1,065 筆 / 2,881 筆）
- **標題格式**：`修正「法規名稱」第X條、第Y條`
- **範例**：修正「有價證券得為融資融券標準」第二、四、五條

### 典型附件結構
```
模式 A（證期局常用）：
├─ 修正條文.odt ← 修正後的新條文 + 修正理由
└─ 總說明及對照表.pdf ← 總說明 + 新舊條文對照表 + 逐條說明

模式 B（銀行局常用）：
├─ 完整辦法.pdf ← 修正後的完整法規
└─ 修正條文對照表.pdf ← 新舊條文對照

模式 C（證期局另一種）：
├─ 總說明及對照表.pdf ← 總說明 + 新舊條文對照表
└─ 修正條文.pdf ← 修正後的新條文
```

### 內容價值分析

#### 對照表 PDF 🔴🔴 極高價值
```
內容包含：
✅ 修正前的舊條文（獨有）
✅ 修正後的新條文
✅ 新舊條文並列對比（視覺化表格）
✅ 修正總說明（背景和要點）
✅ 逐條修正說明
✅ 符合 80% 查詢需求（新舊對比、修正原因、條文演變）
```

#### 修正條文 PDF/ODT 🟡 中等價值
```
內容包含：
✅ 修正後的新條文
✅ 每條的修正理由
❌ 無修正前的舊條文
❌ 無法看出「改了什麼」
⚠️ 內容 100% 包含在對照表中（完全重複）
```

#### 網頁正文 🟢 低價值（metadata）
```
內容包含：
✅ 發文日期、字號、來源
✅ 修正了哪些條文
❌ 無實際條文內容
❌ 無修正理由
```

### 內容重複度分析
```
修正條文 PDF:
- 新條文 ✓
- 修正理由 ✓
        ↓ 100% 重複
對照表 PDF:
- 新條文 ✓（重複）
- 舊條文 ✓（獨有！）
- 修正說明 ✓（重複）
- 總說明 ✓（獨有！）
- 新舊對照表 ✓（獨有！）
```

### ✅ 最終策略

#### 上傳到 Gemini
```python
優先順序：
1. 總說明及對照表.pdf  # 最優先，包含所有關鍵內容
2. 修正條文對照表.pdf  # 次選（如果沒有總說明及對照表）
3. 修正條文.pdf/odt    # 最後選擇（如果都沒有對照表）

❌ 不上傳：
- Markdown metadata（會污染索引）
- 修正條文（如果已有對照表，避免重複）
```

#### 本地 mapping 儲存
```json
{
  "fsc_law_20251114_0002": {
    "date": "2025-11-14",
    "document_number": "金管證投字第1140385196號",
    "source": "證券期貨局",
    "source_raw": "證券期貨局",
    "category": "amendment",
    "law_name": "有價證券得為融資融券標準",
    "amended_articles": [2, 4, 5],
    "title": "修正「有價證券得為融資融券標準」第二條、第四條、第五條",
    "detail_url": "https://www.fsc.gov.tw/...",
    "attachments": [
      {
        "name": "有價證券得為融資融券標準修正條文總說明及對照表.pdf",
        "type": "pdf",
        "category": "comparison_table",
        "original_url": "/uploaddowndoc?file=newslaw/...",
        "local_path": "data/attachments/law_interpretations/fsc_law_20251114_0002/comparison_table.pdf",
        "gemini_id": "files/xxx",
        "uploaded": true
      }
    ],
    "gemini_file_ids": ["files/xxx"]
  }
}
```

### 預期效果
- **檢索精確度**：⭐⭐⭐⭐⭐（無重複內容）
- **查詢覆蓋度**：⭐⭐⭐⭐⭐（對照表包含所有資訊）
- **儲存效率**：⭐⭐⭐⭐⭐（比全部上傳節省 40% 空間）
- **實作難度**：⭐⭐⭐⭐（簡單，不需 PDF 轉換）

### 查詢範例
```
Q: 「2024年有價證券融資融券標準做了哪些修正？」
A: 根據 2024-11-14 的函釋，修正了第2、4、5條...
   【新舊對照】
   - 第2條：原本規定「...」，修正為「...」
   - 修正理由：配合實務需要...

✅ 對照表 PDF 提供完整的新舊對比和修正理由
```

---

## 類型 2：訂定型函釋 ⭐⭐⭐⭐

### 基本資訊
- **頻率**：21%（約 605 筆 / 2,881 筆）
- **標題格式**：
  - `訂定「規定名稱」`
  - `訂定「XX法第Y條」解釋令` ← 重要子類型
- **範例**：
  - 訂定「規範財產保險業得以取具足資證明要保人投保意願相關證據」
  - 訂定「保險法第146條第4項」解釋令

### 典型附件結構
```
模式 A（新規定）：
├─ 訂定條文.pdf/odt ← 新訂定的完整規定
└─ 說明.pdf ← 訂定理由和背景說明（視情況）

模式 B（解釋令）：
├─ 解釋令內容.pdf ← 針對法條的官方解釋
└─ 說明.pdf ← 解釋背景（視情況）

模式 C（無附件）：
- 正文直接包含所有內容（編號條列）
```

### 實際案例分析

#### 案例 1：一般訂定型（dataserno: 202511120001）
```
標題：發布有關「公開發行公司年報應行記載事項準則」第10條之1規定之令

正文結構：
- 兩則獨立的金管會令
- 第一則令：3個段落（依據、認可準則、生效日期）
- 第二則令：8個條文（詳細規定分階段時程）

附件：❌ 無附件

實質內容：✅ 完全在正文中（編號條列：一、二、三...）
```

#### 案例 2：解釋令子類型（推測）
```
標題格式：訂定「XX法第Y條」解釋令

特徵：
- 針對特定法條的官方解釋
- 澄清法條適用疑義
- 可能有附件（解釋令全文 PDF）
```

### 內容價值分析

#### 正文內容 🟡 中高價值
```
內容包含：
✅ 完整的規定內容（編號條列）
✅ 適用範圍和時程
✅ 生效日期
✅ 依據條文
⚠️ 附件比例較低（約 40-60%）
```

#### 附件 PDF（如果有）🟡 中等價值
```
可能包含：
✅ 訂定條文全文（格式化）
✅ 說明和理由
⚠️ 內容可能與正文重複
```

### ✅ 最終策略

#### 上傳到 Gemini
```python
策略：
1. 如果有附件：上傳附件 PDF（訂定條文或解釋令）
2. 如果無附件：生成 Plain Text 或 Markdown（從正文提取）

理由：
- 正文內容完整，需要被索引
- 附件格式化更好，優先上傳
- 無附件時，正文也有價值
```

#### 本地 mapping 儲存
```json
{
  "fsc_law_20251112_0001": {
    "date": "2025-11-12",
    "document_number": ["金管證審字第11403851755號", "金管證審字第11403851756號"],
    "source": "證券期貨局",
    "category": "enactment",
    "sub_category": "interpretation_decree",  // 如果是解釋令
    "law_name": "公開發行公司年報應行記載事項準則",
    "title": "發布有關「公開發行公司年報應行記載事項準則」第10條之1規定之令",
    "has_attachments": false,
    "content_location": "text",  // "text" or "attachments"
    "attachments": [],
    "gemini_file_ids": ["files/xxx"]  // Plain Text 或 附件的 ID
  }
}
```

### 預期效果
- **檢索精確度**：⭐⭐⭐⭐（內容清晰）
- **查詢覆蓋度**：⭐⭐⭐⭐（訂定型包含完整規定）
- **儲存效率**：⭐⭐⭐⭐（無/少附件，節省空間）
- **實作難度**：⭐⭐⭐（需處理無附件情況）

### 與修正型的差異
| 特徵 | 修正型 | 訂定型 |
|------|-------|-------|
| 附件比例 | 95% 有附件 | 40-60% 有附件 |
| 附件價值 | 極高（對照表） | 中等（格式化） |
| 正文完整性 | 低（只有 metadata） | **高（完整規定）** |
| 內容重複 | 高（修正條文 vs 對照表） | 低 |
| 上傳策略 | 只上傳對照表 | **正文或附件都可** |

---

## 類型 3：函釋型（有關）⭐⭐⭐⭐

### 基本資訊
- **頻率**：11%（約 317 筆 / 2,881 筆）
- **標題格式**：`有關【法規名稱】第X條...之令`
- **範例**：有關證券商管理規則第37條之1第2項當日沖銷交易有價證券之種類及範圍之令

### 典型內容結構
```
正文（無附件）：
- 針對特定法條的適用範圍說明
- 條款式呈現（一、二、三...）
- 常包含「廢止前令」資訊
```

### 實際案例分析

#### 案例：dataserno 202511130002
```
標題：有關證券商管理規則第37條之1第2項當日沖銷交易有價證券之種類及範圍之令

正文結構：
- 條款式呈現（一、二、三）
- 列舉適用範圍（三類有價證券）
- 包含「廢止前令」資訊

附件：❌ 無附件

實質內容：✅ 完全在正文中（簡短但完整）

生效日期：114年11月17日
廢止前令：112年12月29日金管證交字第...號令同時廢止
```

### 內容價值分析

#### 正文內容 🟢 中等價值
```
內容包含：
✅ 法條適用範圍的明確說明
✅ 列舉符合條件的項目
✅ 排除條款（變更交易方法或處置者）
✅ 生效日期
✅ 廢止前令資訊（追溯歷史）
❌ 無附件
⚠️ 內容簡短（通常 1-2 段）
```

### RAG 查詢價值

#### 典型查詢場景
```
Q: 「哪些證券可以當日沖銷？」
A: 根據 2025-11-13 的函釋...包括三類：
   1. 臺灣50指數、臺灣中型100指數...成分股
   2. 得為認購權證標的...
   3. 經交易所或櫃檯買賣中心公告者

   惟經變更交易方法或處置之有價證券不得列入。

✅ 函釋型直接回答「適用範圍」問題
✅ 對於理解法條如何適用很重要
```

### ✅ 最終策略

#### 上傳到 Gemini
```python
策略：生成 Plain Text 或 Markdown（從正文提取）

處理方式：
1. 提取網頁正文內容
2. 清理格式（移除 HTML 標籤、社群分享按鈕等）
3. 轉換為結構化 Markdown
4. 上傳 Markdown 或 Plain Text

理由：
- ❌ 幾乎無附件（10%）
- ✅ 正文內容簡短但完整
- ✅ 需要被索引以回答「適用範圍」查詢
- ✅ 內容不會污染索引（都是實質法規內容）
```

#### Markdown 格式範例
```markdown
# 有關證券商管理規則第37條之1第2項當日沖銷交易有價證券之種類及範圍之令

**發文日期**：2025-11-13
**發文字號**：金管證交字第1140385177號
**來源**：證券期貨局
**生效日期**：2025-11-17

## 適用範圍

一、臺灣50指數、臺灣中型100指數及櫃買富櫃五十指數之成分股。

二、得為認購權證標的、融資融券或有價證券借貸交易標的之有價證券。

三、經交易所或櫃檯買賣中心公告者。

惟經變更交易方法或處置之有價證券不得列入。

## 廢止前令

本令自114年11月17日生效；本會112年12月29日金管證交字第1120387676號令同時廢止。
```

#### 本地 mapping 儲存
```json
{
  "fsc_law_20251113_0002": {
    "date": "2025-11-13",
    "document_number": "金管證交字第1140385177號",
    "source": "證券期貨局",
    "category": "clarification",
    "law_reference": "證券商管理規則第37條之1第2項",
    "title": "有關證券商管理規則第37條之1第2項當日沖銷交易有價證券之種類及範圍之令",
    "effective_date": "2025-11-17",
    "repealed_decree": "112年12月29日金管證交字第1120387676號令",
    "has_attachments": false,
    "content_location": "generated_markdown",
    "gemini_file_ids": ["files/xxx"]
  }
}
```

### 預期效果
- **檢索精確度**：⭐⭐⭐⭐（內容精簡，無噪音）
- **查詢覆蓋度**：⭐⭐⭐⭐（直接回答「適用範圍」問題）
- **儲存效率**：⭐⭐⭐⭐⭐（檔案最小，無附件）
- **實作難度**：⭐⭐⭐（需要提取和格式化正文）

### 與其他類型的差異
| 特徵 | 修正型 | 訂定型 | 函釋型（有關）|
|------|-------|-------|--------------|
| 附件比例 | 95% | 40-60% | **10%** |
| 正文長度 | 短 | 中長 | **短** |
| 內容位置 | 附件 | 正文 | **正文** |
| 主要功能 | 修改條文 | 新增規定 | **解釋適用** |
| 查詢場景 | 法規演變 | 新規定內容 | **適用範圍** |
| 上傳策略 | 對照表 PDF | 附件或正文 | **生成 Markdown** |

---

## 類型 4-N：其他類型快速評估

### 廢止型（13%，約 374 筆）⭐
```
標題格式：廢止 XX年X月X日金管X字第XXXXXXXX號令
內容：明確廢除特定日期的舊令
附件：❌ 幾乎無附件

RAG 價值：🟡 低-中
- 提供歷史追溯（哪些規定已廢止）
- 避免引用過時法令
- 但對當前法規適用幫助較小

建議：✅ 爬取但優先級較低（P2）
```

### 發布/公布型（8%，約 230 筆）⭐⭐
```
標題格式：發布「法規名稱」XX條規定之令
內容：正式發布新法規條文
附件：⚠️ 可能有條文 PDF

RAG 價值：🟡 中
- 與訂定型類似
- 正式公布法規條文

建議：✅ 爬取（P1，可併入訂定型處理）
```

### 核准/指定型（9%，約 260 筆）⭐⭐
```
標題格式：
- 指定 XX 為 YY 法所稱同業公會
- 核准 XX 業務範圍

內容：核准特定機構的業務或指定角色
附件：⚠️ 視情況

RAG 價值：🟢 中-高（對特定查詢）
- 例：「哪個公會是電子支付的同業公會？」
- 例：「XX 公司核准辦理哪些業務？」

建議：✅ 爬取（P1）
```

### 調整型（較少）⭐
```
標題格式：調降 XX 保證金成數
內容：調整技術性參數
附件：❌ 很少

RAG 價值：🟡 低-中
- 技術性參數變更
- 時效性強（容易過時）

建議：⚠️ 可選爬取（P2）
```

### 公告型（程序性）⭐
```
標題格式：公告 XX 處理期間表
內容：程序性公告
附件：⚠️ 表格類

RAG 價值：🟢 低
- 程序性資訊
- 對法規理解幫助小

建議：❌ 優先級最低（P3 或不爬）
```

---

## 🎯 最終爬取策略

### 優先級分級

#### **P0（必須爬取）- 核心法規類**
```
類型：修正型、訂定型、函釋型（有關）
頻率：69%（約 1,987 筆）
預估時間：爬取 6-8 小時 + 上傳 8-10 小時
預估大小：1.5-2 GB（含附件）

理由：
✅ 直接影響法規適用
✅ 對 RAG 查詢價值極高
✅ 覆蓋 80% 的查詢需求
```

#### **P1（建議爬取）- 補充類**
```
類型：核准/指定型、發布/公布型
頻率：17%（約 490 筆）
預估時間：爬取 3-4 小時 + 上傳 3-4 小時
預估大小：300-500 MB

理由：
✅ 補充特定類型查詢（機構資格、業務範圍）
✅ 與訂定型相似，實作成本低
```

#### **P2（可選爬取）- 歷史類**
```
類型：廢止型、調整型
頻率：約 15%（約 432 筆）
預估時間：爬取 2-3 小時 + 上傳 1-2 小時

理由：
⚠️ 提供歷史追溯
⚠️ 但對當前法規適用幫助較小
⚠️ 可視資源決定是否爬取
```

#### **P3（不建議爬取）- 程序類**
```
類型：公告型（程序性）
理由：
❌ 程序性資訊
❌ 對法規理解幫助極小
❌ 浪費儲存和索引空間
```

### 階段式實作建議

#### **階段 1：MVP（最小可行產品）**
```
範圍：P0（修正型、訂定型、函釋型）
目標：快速驗證效果，回答核心查詢

預期成果：
- 爬取：1,987 筆
- 上傳：約 1,500-1,800 個檔案（考慮無附件情況）
- 查詢能力：回答 80% 的法規相關問題
```

#### **階段 2：完整版**
```
範圍：P0 + P1
目標：覆蓋更多查詢場景

預期成果：
- 爬取：2,477 筆（86%）
- 上傳：約 2,000 個檔案
- 查詢能力：回答 90% 的法規相關問題
```

#### **階段 3：全量（可選）**
```
範圍：P0 + P1 + P2
目標：完整歷史追溯

預期成果：
- 爬取：2,909 筆（>90%）
- 查詢能力：回答 95% 的法規相關問題
```

### 上傳策略總結

| 類型 | 上傳內容 | 本地儲存 metadata | 預期效果 |
|------|---------|------------------|---------|
| **修正型** | 對照表 PDF 或修正條文 | 日期、字號、法規名稱、修正條文 | ⭐⭐⭐⭐⭐ |
| **訂定型** | 附件 PDF 或生成 Markdown | 日期、字號、法規名稱、解釋令標記 | ⭐⭐⭐⭐ |
| **函釋型** | 生成 Markdown | 日期、字號、法條引用、廢止前令 | ⭐⭐⭐⭐ |
| **核准/指定型** | 生成 Markdown 或附件 | 日期、字號、機構名稱、核准事項 | ⭐⭐⭐ |
| **廢止型** | 生成 Markdown | 日期、字號、廢止令號 | ⭐⭐ |

### 資料量估算（P0 + P1）

```
總函釋數：2,477 筆
├─ 有附件：約 1,200 筆
│  ├─ PDF：約 1,000 個（平均 2 MB）→ 2 GB
│  └─ ODT：約 200 個（平均 500 KB）→ 100 MB
└─ 無附件：約 1,277 筆
   └─ 生成 Markdown（平均 5 KB）→ 6 MB

總大小：約 2.1 GB
上傳時間：約 12-14 小時（延遲 3-4 秒/檔案）
```

---

## 📋 實作檢查清單

### 階段 1：爬蟲實作
- [ ] 實作 `LawInterpretationsCrawler`（繼承 `BaseFSCCrawler`）
- [ ] 支援列表頁解析（POST 表單分頁）
- [ ] 支援詳細頁解析（三種類型）
- [ ] 支援附件下載（PDF, ODT, DOC, DOCX）
- [ ] 類型識別邏輯（修正/訂定/函釋等）
- [ ] 無附件處理：生成 Markdown

### 階段 2：資料處理
- [ ] 實作 `LawInterpretationMarkdownFormatter`
- [ ] 正文提取和清理（移除 HTML 噪音）
- [ ] Markdown 格式化
- [ ] metadata 提取（日期、字號、法規名稱等）

### 階段 3：上傳和整合
- [ ] 修改 `GeminiUploader` 支援 law_interpretations
- [ ] 建立 `law_interpretations_mapping.json`
- [ ] 建立反向映射 `gemini_id_mapping.json`
- [ ] 上傳腳本（批次上傳，支援斷點續傳）

### 階段 4：前端整合（FSC-Penalties-Deploy）
- [ ] 整合 law_interpretations Store
- [ ] 修改查詢邏輯（同時檢索裁罰和函釋）
- [ ] 顯示函釋結果（標題、日期、來源、連結）
- [ ] 測試範例問題

---

## 💡 關鍵決策記錄

### 決策 1：不上傳 Markdown metadata
**原因**：Gemini File API 不支援獨立 metadata 儲存，所有上傳內容都會被索引。Markdown metadata 會污染檢索結果。
**解決**：本地維護 `law_interpretations_mapping.json`。

### 決策 2：修正型只上傳對照表
**原因**：對照表包含所有內容（新舊條文對比），修正條文內容 100% 重複。
**效果**：節省 40% 空間，避免重複檢索結果。

### 決策 3：無附件時生成 Markdown
**原因**：訂定型和函釋型約 50-60% 無附件，但正文有完整內容。
**解決**：提取正文生成結構化 Markdown 上傳。

### 決策 4：分階段實作（P0 → P1 → P2）
**原因**：快速驗證效果，避免過度投入。
**策略**：先實作核心類型（69%），驗證查詢效果後再擴充。
