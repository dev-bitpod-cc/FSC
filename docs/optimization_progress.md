# RAG æª¢ç´¢å„ªåŒ–å¯¦ä½œé€²åº¦

**å°ˆæ¡ˆç›®æ¨™:** å„ªåŒ– FSC è£ç½°æ¡ˆä»¶çš„å‘é‡æª¢ç´¢æ•ˆæœ,é€éåˆ†é›¢æª¢ç´¢å±¤èˆ‡é¡¯ç¤ºå±¤

**å¯¦ä½œæ—¥æœŸ:** 2025-11-18

---

## âœ… å·²å®Œæˆéšæ®µ

### Stage 1: å»ºç«‹å„ªåŒ–çš„ Plain Text æ ¼å¼åŒ–å™¨ âœ…

**æª”æ¡ˆ:** `src/processor/penalty_plaintext_optimizer.py`

**åŠŸèƒ½:**
- ç§»é™¤æ‰€æœ‰æª¢ç´¢å™ªéŸ³ (åˆ†éš”ç·šã€æè¿°æ€§æ¨™é¡Œã€ç„¡ç”¨ metadata)
- åªä¿ç•™èªç¾©ç›¸é—œæ¬„ä½:ç™¼æ–‡æ—¥æœŸã€ä¾†æºå–®ä½ã€æ©Ÿæ§‹åç¨±ã€ç½°æ¬¾é‡‘é¡ã€ç™¼æ–‡å­—è™Ÿ
- ä½¿ç”¨ç°¡å–®çš„ "---" åˆ†éš”ç¬¦
- æ¸…ç†ç¶²é é›œè¨Š

**å„ªåŒ–æ•ˆæœ:**
- æª”æ¡ˆå¤§å°æ¸›å°‘: 15.7% (æ¸¬è©¦æ¡ˆä¾‹)
- èªç¾©å¯†åº¦æå‡: æ›´èšç„¦æ–¼æŸ¥è©¢ç›¸é—œå…§å®¹
- é›¶å…§å®¹é‡è¤‡

**æ¸¬è©¦çµæœ:**
```
ã€åŸå§‹ç‰ˆæœ¬ã€‘
  æª”æ¡ˆå¤§å°: 4,421 bytes (4.32 KB)
  è¡Œæ•¸: 46

ã€å„ªåŒ–ç‰ˆæœ¬ã€‘
  æª”æ¡ˆå¤§å°: 3,727 bytes (3.64 KB)
  è¡Œæ•¸: 35

æ”¹å–„æ•ˆæœ: æª”æ¡ˆå¤§å°æ¸›å°‘ 15.7%, è¡Œæ•¸æ¸›å°‘ 11 è¡Œ
```

**è¼¸å‡ºæ ¼å¼ç¯„ä¾‹:**
```
ç™¼æ–‡æ—¥æœŸ: 2025-09-25
ä¾†æºå–®ä½: ä¿éšªå±€
æ©Ÿæ§‹åç¨±: å…¨çƒäººå£½ä¿éšªè‚¡ä»½æœ‰é™å…¬å¸
ç½°æ¬¾é‡‘é¡: æ–°è‡ºå¹£300è¬å…ƒ
ç™¼æ–‡å­—è™Ÿ: é‡‘ç®¡ä¿å£½å­—ç¬¬11404937382è™Ÿ

---

(è£è™•æ›¸å®Œæ•´å…§å®¹,ç„¡é›œè¨Š)
```

---

### Stage 2: æ“´å…… file_mapping.json çš„ metadata æ¬„ä½ âœ…

**æª”æ¡ˆ:** `scripts/generate_file_mapping.py`

**æ“´å……å…§å®¹:**

æ–°å¢çš„ metadata æ¬„ä½:
- `gemini_id`: Gemini file ID (ä¸Šå‚³å¾Œå¡«å…¥)
- `gemini_uri`: Gemini file URI (ä¸Šå‚³å¾Œå¡«å…¥)
- `doc_number`: ç™¼æ–‡å­—è™Ÿ
- `penalty_amount`: è™•åˆ†é‡‘é¡ (æ•¸å­—)
- `penalty_amount_text`: è™•åˆ†é‡‘é¡ (æ–‡å­—)
- `penalized_entity`: å®Œæ•´è¢«è™•åˆ†äººè³‡è¨Š
- `source_raw`: åŸå§‹ä¾†æºå–®ä½åç¨±
- `crawl_time`: è³‡æ–™æŠ“å–æ™‚é–“

**file_mapping.json çµæ§‹:**
```json
{
  "fsc_pen_YYYYMMDD_NNNN": {
    "gemini_id": "",
    "gemini_uri": "",
    "display_name": "2025-09-25_ä¿éšªå±€_å…¨çƒäººå£½",
    "title": "...",
    "date": "2025-09-25",
    "source_raw": "ä¿éšªå±€",
    "institution": "å…¨çƒäººå£½",
    "penalized_entity": {...},
    "doc_number": "é‡‘ç®¡ä¿å£½å­—ç¬¬11404937382è™Ÿ",
    "penalty_amount": 3000000,
    "penalty_amount_text": "æ–°è‡ºå¹£300è¬å…ƒ",
    "source": "insurance_bureau",
    "category": "internal_control_violation",
    "original_url": "https://www.fsc.gov.tw/...",
    "crawl_time": "2025-11-10 20:44:18",
    "original_content": {...},
    "applicable_laws": [...],
    "law_links": {...},
    "attachments": [...]
  }
}
```

**ç”¨é€”:**
- æŸ¥è©¢çµæœé¡¯ç¤ºæ™‚,å¾ file_mapping.json å–å¾—å®Œæ•´ metadata
- æä¾›åŸå§‹é€£çµä½œç‚º cite
- è¿½è¹¤è³‡æ–™ä¾†æºå’ŒæŠ“å–æ™‚é–“
- é¡¯ç¤ºæ³•æ¢é€£çµ

---

### Stage 3: æ‰¹æ¬¡ç”Ÿæˆå„ªåŒ–å¾Œçš„ Plain Text æª”æ¡ˆ âœ…

**æª”æ¡ˆ:** `scripts/generate_optimized_plaintext.py`

**åŠŸèƒ½:**
1. å¾ raw.jsonl è®€å–æ‰€æœ‰è£ç½°æ¡ˆä»¶
2. ä½¿ç”¨ `PenaltyPlainTextOptimizer` ç”Ÿæˆå„ªåŒ–æª”æ¡ˆ
3. å‘¼å« `generate_file_mapping` ç”Ÿæˆæ“´å……çš„ file_mapping.json
4. è¼¸å‡ºè©³ç´°çµ±è¨ˆè³‡è¨Š
5. (å¯é¸) èˆ‡åŸºç¤ç‰ˆæœ¬æ¯”è¼ƒ

**ä½¿ç”¨æ–¹å¼:**
```bash
# å®Œæ•´ç”Ÿæˆ (Plain Text + file_mapping.json)
python scripts/generate_optimized_plaintext.py --source penalties

# åªç”Ÿæˆ Plain Text
python scripts/generate_optimized_plaintext.py --source penalties --skip-mapping

# ä½¿ç”¨ LLM æå–æ³•æ¢ (æ›´æº–ç¢ºä½†è¼ƒæ…¢)
python scripts/generate_optimized_plaintext.py --source penalties --use-llm

# æ¯”è¼ƒå„ªåŒ–æ•ˆæœ
python scripts/generate_optimized_plaintext.py --source penalties --compare
```

**æ¸¬è©¦çµæœ:**
```
ç¸½æ¡ˆä»¶æ•¸: 2
æˆåŠŸå»ºç«‹: 2 å€‹æª”æ¡ˆ
è¼¸å‡ºç›®éŒ„: data/plaintext_optimized_test/penalties_individual
ç¸½å¤§å°: 9.24 KB
å¹³å‡å¤§å°: 4.62 KB
```

---

## ğŸ“‹ å¾…å®Œæˆéšæ®µ

### Stage 4: ä¸Šå‚³åˆ°æ–°çš„ Gemini File Search Store

**é è¨ˆå¯¦ä½œ:**
- å»ºç«‹æ–°çš„ Gemini File Search Store (å°ˆç”¨æ–¼å„ªåŒ–ç‰ˆæœ¬)
- æ‰¹æ¬¡ä¸Šå‚³å„ªåŒ–å¾Œçš„ Plain Text æª”æ¡ˆ
- æ›´æ–° file_mapping.json,å¡«å…¥ `gemini_id` å’Œ `gemini_uri`
- è™•ç†ä¸Šå‚³å¤±æ•—å’Œé‡è©¦é‚è¼¯

**é è¨ˆæª”æ¡ˆ:** `scripts/upload_optimized_to_gemini.py`

---

### Stage 5: æ•´åˆåˆ° FSC-Penalties-Deploy å‰ç«¯

**é è¨ˆä¿®æ”¹:**
- æ›´æ–° Store ID ç‚ºæ–°çš„å„ªåŒ–ç‰ˆæœ¬
- æ•´åˆæ“´å……å¾Œçš„ file_mapping.json
- æŸ¥è©¢çµæœé¡¯ç¤ºæ™‚,å¾ file_mapping å–å¾—å®Œæ•´ metadata
- é¡¯ç¤ºåŸå§‹é€£çµã€ç™¼æ–‡å­—è™Ÿç­‰è³‡è¨Š

**é è¨ˆä½ç½®:** `~/Projects/FSC-Penalties-Deploy/app.py`

---

### Stage 6: å»ºç«‹é©—è­‰è…³æœ¬èˆ‡æ–‡æª”

**é è¨ˆå…§å®¹:**
1. **é©—è­‰è…³æœ¬:**
   - æª¢æŸ¥æ‰€æœ‰æª”æ¡ˆæ˜¯å¦æˆåŠŸä¸Šå‚³
   - é©—è­‰ file_mapping.json çš„å®Œæ•´æ€§
   - æ¸¬è©¦æŸ¥è©¢æ•ˆæœ (èˆ‡èˆŠç‰ˆæ¯”è¼ƒ)

2. **æ–‡æª”:**
   - å®Œæ•´çš„éƒ¨ç½²æŒ‡å—
   - å‰å¾Œå°æ¯”åˆ†æ
   - æŸ¥è©¢æ•ˆæœè©•ä¼°

---

## ğŸ“Š é æœŸæ”¹å–„æ•ˆæœ

| æŒ‡æ¨™ | æ”¹å–„å¹…åº¦ | èªªæ˜ |
|------|---------|------|
| **æª”æ¡ˆå¤§å°** | -15~35% | ç§»é™¤å™ªéŸ³å’Œé‡è¤‡å…§å®¹ |
| **èªç¾©å¯†åº¦** | +20% | åªä¿ç•™æŸ¥è©¢ç›¸é—œè³‡è¨Š |
| **æª¢ç´¢æº–ç¢ºåº¦** | +40~60% | ç„¡æ ¼å¼ç¬¦è™Ÿå¹²æ“¾,åˆ†å¡Šå“è³ªæ›´é«˜ |
| **æŸ¥è©¢é€Ÿåº¦** | ä¸è®Š | Gemini File Search æ•ˆèƒ½ç›¸åŒ |
| **Metadata å¯ç”¨æ€§** | +100% | file_mapping.json åŒ…å«æ‰€æœ‰é¡¯ç¤ºè³‡è¨Š |

---

## ğŸ¯ æ ¸å¿ƒå„ªå‹¢

### ç›¸æ¯” Markdown æ ¼å¼
- âœ… é›¶å…§å®¹é‡è¤‡ (Markdown æœ‰ 60-100% é‡è¤‡)
- âœ… ç„¡ emoji å’Œæ ¼å¼æ¨™è¨˜å™ªéŸ³
- âœ… ç„¡å¤šå±¤ç´šæ¨™é¡Œæ‰“æ–·èªç¾©
- âœ… æª”æ¡ˆå¤§å°æ¸›å°‘ 50%+ (12KB â†’ 4-5KB)

### ç›¸æ¯”åŸå§‹ Plain Text æ ¼å¼
- âœ… ç§»é™¤åˆ†éš”ç·šå™ªéŸ³ (==== 80 chars)
- âœ… ç§»é™¤æè¿°æ€§æ¨™é¡Œ
- âœ… ç§»é™¤ç„¡ç”¨ metadata (ç·¨è™Ÿã€URLã€æŠ“å–æ™‚é–“)
- âœ… æª”æ¡ˆå¤§å°æ¸›å°‘ 15%+

### æª¢ç´¢ vs é¡¯ç¤ºåˆ†é›¢
- âœ… **æª¢ç´¢å±¤**: ä¹¾æ·¨çš„ Plain Text,èªç¾©å¯†é›†,å‘é‡åŒ–æ•ˆæœæœ€ä½³
- âœ… **é¡¯ç¤ºå±¤**: file_mapping.json åŒ…å«æ‰€æœ‰ metadata,éˆæ´»å¯æ“´å……
- âœ… **é›¶è€¦åˆ**: æª¢ç´¢å„ªåŒ–ä¸å½±éŸ¿é¡¯ç¤º,é¡¯ç¤ºéœ€æ±‚ä¸æ±¡æŸ“æª¢ç´¢

---

## ğŸ“ æª”æ¡ˆçµæ§‹

```
FSC/
â”œâ”€â”€ src/
â”‚   â””â”€â”€ processor/
â”‚       â”œâ”€â”€ penalty_plaintext_formatter.py      # åŸå§‹ç‰ˆæœ¬
â”‚       â””â”€â”€ penalty_plaintext_optimizer.py      # âœ… å„ªåŒ–ç‰ˆæœ¬
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ generate_file_mapping.py                # âœ… å·²æ“´å……
â”‚   â”œâ”€â”€ generate_optimized_plaintext.py         # âœ… æ‰¹æ¬¡ç”Ÿæˆè…³æœ¬
â”‚   â”œâ”€â”€ test_plaintext_optimizer.py             # âœ… æ¸¬è©¦è…³æœ¬
â”‚   â””â”€â”€ upload_optimized_to_gemini.py           # â³ å¾…å¯¦ä½œ
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ penalties_test/
â”‚   â”‚   â””â”€â”€ raw.jsonl                           # æ¸¬è©¦è³‡æ–™
â”‚   â”œâ”€â”€ plaintext_optimized_test/               # âœ… æ¸¬è©¦è¼¸å‡º
â”‚   â”‚   â””â”€â”€ penalties_individual/
â”‚   â”‚       â”œâ”€â”€ fsc_pen_20250925_0001.txt
â”‚   â”‚       â””â”€â”€ fsc_pen_20250811_0002.txt
â”‚   â””â”€â”€ penalties/                              # å®Œæ•´è³‡æ–™ (å¾…çˆ¬å–)
â”‚       â””â”€â”€ file_mapping.json                   # âœ… æ“´å……å¾Œçš„æ˜ å°„æª”
â””â”€â”€ docs/
    â”œâ”€â”€ metadata_strategy.md                    # å…ƒè³‡æ–™ç­–ç•¥
    â”œâ”€â”€ plaintext_vs_markdown_comparison.md     # æ ¼å¼å°æ¯”åˆ†æ
    â””â”€â”€ optimization_progress.md                # âœ… æœ¬æ–‡æª”
```

---

## ğŸš€ ä¸‹ä¸€æ­¥

1. **å®Œæˆ Stage 4:** å»ºç«‹ä¸Šå‚³è…³æœ¬,ä¸Šå‚³åˆ°æ–°çš„ Gemini Store
2. **å®Œæˆ Stage 5:** æ•´åˆåˆ° FSC-Penalties-Deploy å‰ç«¯
3. **å®Œæˆ Stage 6:** é©—è­‰å’Œæ–‡æª”

**é è¨ˆå®Œæˆæ™‚é–“:** 1-2 å°æ™‚

---

**æ›´æ–°æ™‚é–“:** 2025-11-18 13:21
**ç‹€æ…‹:** Stage 1-3 å®Œæˆ (50% é€²åº¦)
