# é‡‘ç®¡æœƒçˆ¬èŸ²æ¶æ§‹è¨­è¨ˆ - å®Œæ•´èªªæ˜

## æ‚¨çš„ä¸‰å€‹é—œéµå•é¡Œ

### 1ï¸âƒ£ æ—¢ç„¶ä¸Šå‚³æ™‚æ˜¯ä»¥å–®ç¯‡å…¬å‘Šç‚ºä¸€å€‹æª”æ¡ˆå–®å…ƒ,é‚£å°±ä¸éœ€è¦æ™ºæ…§åˆ†å‰²äº†

**âœ… æ­£ç¢º!** æ‡‰è©²ç°¡åŒ–ä¸Šå‚³å™¨,ç§»é™¤åˆ†å‰²åŠŸèƒ½ã€‚

### 2ï¸âƒ£ çˆ¬æ–‡è³‡æ–™çš„å„²å­˜,è¦èƒ½å¤ æ–°å¢çˆ¬æ–‡,ä¹Ÿè¦èƒ½å¤ ç”¨å¦ä¸€å€‹ Gemini API Key ä¸Šå‚³åˆ°å¦ä¸€å€‹ File Search Store å»é‡å»ºç´¢å¼•

**âœ… ç›®å‰å·²æ”¯æ´!** è¨­è¨ˆèªªæ˜å¦‚ä¸‹ã€‚

### 3ï¸âƒ£ é€™äº›è¢«åˆ†å‡ºä¾†ä¸Šå‚³çš„å–®ç¯‡å…¬å‘Š md,ä¸Šå‚³çµæŸå¾Œæœƒåˆªé™¤å—?

**ğŸ’¡ é—œéµè¨­è¨ˆæ±ºç­–!** éœ€è¦æ±ºå®šå„²å­˜ç­–ç•¥ã€‚

---

## å»ºè­°çš„å®Œæ•´æ¶æ§‹

### è³‡æ–™æµç¨‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   çˆ¬èŸ²æŠ“å–è³‡æ–™    â”‚
â”‚  (150 ç­†å…¬å‘Š)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å„²å­˜ç‚º JSONL    â”‚ â† ä¸»è¦å„²å­˜æ ¼å¼ (æ°¸ä¹…ä¿å­˜)
â”‚ raw.jsonl       â”‚    æ¯è¡Œä¸€ç­† JSON
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å»ºç«‹ç´¢å¼•        â”‚
â”‚  index.json     â”‚ â† å¿«é€ŸæŸ¥è©¢ç”¨
â”‚  metadata.json  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                  â”‚
         â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¢ç”Ÿ Markdown   â”‚   â”‚  å¢é‡çˆ¬å–       â”‚
â”‚ (æŒ‰éœ€ç”¢ç”Ÿ)      â”‚   â”‚ (è¿½åŠ åˆ° JSONL)  â”‚
â”‚ æš«å­˜æª”æ¡ˆ        â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸Šå‚³åˆ° Gemini   â”‚
â”‚ (æ¯ç¯‡å…¬å‘Šç¨ç«‹)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸Šå‚³å®Œæˆå¾Œ      â”‚
â”‚ åˆªé™¤æš«å­˜ MD æª”  â”‚ â† ç¯€çœç£ç¢Ÿç©ºé–“
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## è©³ç´°è¨­è¨ˆ

### å„²å­˜ç­–ç•¥

#### æ–¹æ¡ˆ A: JSONL ç‚ºä¸»å„²å­˜,Markdown ç‚ºæš«å­˜ âœ… æ¨è–¦

**è¨­è¨ˆç†å¿µ**:
- **JSONL** = å”¯ä¸€çœŸç›¸ä¾†æº (Source of Truth)
- **Markdown** = æš«å­˜æ ¼å¼,ç”¨æ–¼ä¸Šå‚³å¾Œå³åˆªé™¤
- **Gemini** = æŸ¥è©¢ç´¢å¼•,éš¨æ™‚å¯å¾ JSONL é‡å»º

**å„ªé»**:
- âœ… é¿å… 7,500 å€‹ Markdown æª”æ¡ˆ
- âœ… ç¯€çœç£ç¢Ÿç©ºé–“
- âœ… JSONL æ˜“æ–¼å¢é‡æ›´æ–°
- âœ… å¯éš¨æ™‚å¾ JSONL é‡æ–°ç”¢ç”Ÿ Markdown

**ç¼ºé»**:
- âš ï¸ éœ€è¦æ™‚æ‰ç”¢ç”Ÿ Markdown (å¤šä¸€å€‹æ­¥é©Ÿ)

**æª”æ¡ˆçµæ§‹**:
```
data/
â”œâ”€â”€ announcements/
â”‚   â”œâ”€â”€ raw.jsonl           # ä¸»å„²å­˜ (7,500 è¡Œ)
â”‚   â”œâ”€â”€ index.json          # ç´¢å¼•
â”‚   â””â”€â”€ metadata.json       # å…ƒè³‡æ–™
â”œâ”€â”€ temp_markdown/          # æš«å­˜ç›®éŒ„ (ä¸Šå‚³å¾Œåˆªé™¤)
â”‚   â”œâ”€â”€ fsc_ann_*.md       # æš«å­˜çš„ Markdown æª”æ¡ˆ
â”‚   â””â”€â”€ .gitignore         # ä¸ç´å…¥ç‰ˆæ§
â””â”€â”€ upload_manifest.json    # ä¸Šå‚³è¨˜éŒ„
```

#### æ–¹æ¡ˆ B: JSONL + Markdown é›™å„²å­˜

**è¨­è¨ˆç†å¿µ**:
- åŒæ™‚ä¿ç•™ JSONL å’Œ Markdown
- Markdown ä½œç‚ºæ°¸ä¹…å„²å­˜

**å„ªé»**:
- âœ… Markdown å¯ç›´æ¥é–±è®€
- âœ… ä¸éœ€è¦é‡æ–°ç”¢ç”Ÿ

**ç¼ºé»**:
- âŒ 7,500 å€‹ Markdown æª”æ¡ˆ
- âŒ åˆ—èˆ‰æª”æ¡ˆæ™‚é€Ÿåº¦æ…¢
- âŒ Git æ“ä½œæ…¢ (å¦‚æœç´å…¥ç‰ˆæ§)
- âŒ ç£ç¢Ÿç©ºé–“å¤§ (~75 MB)
- âŒ å¢é‡æ›´æ–°æ™‚è¦åŒæ­¥å…©ç¨®æ ¼å¼

---

## æ¨è–¦çš„å¯¦ä½œæ–¹æ¡ˆ (æ–¹æ¡ˆ A)

### å·¥ä½œæµç¨‹

#### 1. çˆ¬å–è³‡æ–™ (å¢é‡æ”¯æ´)

```python
from src.crawlers.announcements import AnnouncementCrawler

crawler = AnnouncementCrawler(config)

# é¦–æ¬¡çˆ¬å–
items = crawler.crawl_all(start_page=1, end_page=500)
storage.write_items('announcements', items)

# å¢é‡çˆ¬å– (åªçˆ¬æœ€æ–°çš„)
new_items = crawler.crawl_latest(days=7)  # æœ€è¿‘ 7 å¤©
storage.append_items('announcements', new_items)
```

#### 2. ç”¢ç”Ÿæš«å­˜ Markdown

```python
from src.processor.markdown_formatter import BatchMarkdownFormatter

formatter = BatchMarkdownFormatter()

# ç”¢ç”Ÿåˆ°æš«å­˜ç›®éŒ„
result = formatter.format_individual_files(
    data_type='announcements',
    output_dir='data/temp_markdown',  # æš«å­˜ç›®éŒ„
    cleanup=False  # å…ˆä¸æ¸…ç†,ä¸Šå‚³å¾Œå†æ¸…
)

print(f"ç”¢ç”Ÿ {result['created_files']} å€‹æš«å­˜ Markdown æª”æ¡ˆ")
```

#### 3. ä¸Šå‚³åˆ° Gemini (æ”¯æ´å¤šå€‹ Store)

```python
from src.uploader.gemini_uploader import GeminiUploader

# Store 1: ç”Ÿç”¢ç’°å¢ƒ
uploader_prod = GeminiUploader(
    api_key='prod_api_key',
    store_name='fsc-announcements-prod'
)

stats = uploader_prod.upload_directory(
    'data/temp_markdown',
    auto_split=False,  # ä¸éœ€è¦åˆ†å‰²
    skip_existing=True
)

# Store 2: æ¸¬è©¦ç’°å¢ƒ
uploader_test = GeminiUploader(
    api_key='test_api_key',
    store_name='fsc-announcements-test'
)

stats = uploader_test.upload_directory(
    'data/temp_markdown',
    auto_split=False,
    skip_existing=False  # æ¸¬è©¦ç’°å¢ƒå…¨éƒ¨é‡æ–°ä¸Šå‚³
)
```

#### 4. æ¸…ç†æš«å­˜æª”æ¡ˆ

```python
import shutil
from pathlib import Path

# ä¸Šå‚³å®Œæˆå¾Œåˆªé™¤æš«å­˜ç›®éŒ„
temp_dir = Path('data/temp_markdown')
if temp_dir.exists():
    shutil.rmtree(temp_dir)
    print(f"å·²æ¸…ç†æš«å­˜ç›®éŒ„: {temp_dir}")
```

#### 5. å®Œæ•´çš„ä¸Šå‚³è…³æœ¬

```python
# scripts/upload_to_gemini.py
def upload_to_gemini(
    api_key: str,
    store_name: str,
    force_regenerate: bool = False
):
    """
    å®Œæ•´çš„ä¸Šå‚³æµç¨‹

    Args:
        api_key: Gemini API Key
        store_name: Store åç¨±
        force_regenerate: å¼·åˆ¶é‡æ–°ç”¢ç”Ÿ Markdown
    """
    temp_dir = Path('data/temp_markdown')

    try:
        # 1. æª¢æŸ¥æ˜¯å¦éœ€è¦ç”¢ç”Ÿ Markdown
        if force_regenerate or not temp_dir.exists():
            logger.info("ç”¢ç”Ÿæš«å­˜ Markdown æª”æ¡ˆ...")
            formatter = BatchMarkdownFormatter()
            result = formatter.format_individual_files(
                data_type='announcements',
                output_dir=str(temp_dir)
            )
            logger.info(f"ç”¢ç”Ÿ {result['created_files']} å€‹æª”æ¡ˆ")
        else:
            logger.info("ä½¿ç”¨ç¾æœ‰çš„æš«å­˜ Markdown æª”æ¡ˆ")

        # 2. ä¸Šå‚³åˆ° Gemini
        logger.info(f"ä¸Šå‚³åˆ° Store: {store_name}")
        uploader = GeminiUploader(
            api_key=api_key,
            store_name=store_name,
            max_retries=3
        )

        stats = uploader.upload_directory(
            str(temp_dir),
            skip_existing=True,
            auto_split=False  # ä¸éœ€è¦åˆ†å‰²
        )

        logger.info(f"ä¸Šå‚³å®Œæˆ: {stats['uploaded_files']}/{stats['total_files']}")

        # 3. é©—è­‰å®Œæ•´æ€§
        report = uploader.verify_upload_completeness()
        if report['failed'] > 0:
            logger.warning(f"æœ‰ {report['failed']} å€‹æª”æ¡ˆä¸Šå‚³å¤±æ•—")
            return False

        return True

    finally:
        # 4. æ¸…ç†æš«å­˜æª”æ¡ˆ
        if temp_dir.exists():
            logger.info("æ¸…ç†æš«å­˜æª”æ¡ˆ...")
            shutil.rmtree(temp_dir)
            logger.info("æ¸…ç†å®Œæˆ")
```

---

## æ•ˆèƒ½åˆ†æ

### æª”æ¡ˆæ•¸é‡å°æ¯”

| æƒ…å¢ƒ | JSONL | Markdown | ç¸½æª”æ¡ˆæ•¸ |
|-----|-------|----------|---------|
| æ–¹æ¡ˆ A (æ¨è–¦) | 1 å€‹ | 0 å€‹ (æš«å­˜) | **1 å€‹** |
| æ–¹æ¡ˆ B | 1 å€‹ | 7,500 å€‹ | **7,501 å€‹** |

### åˆ—èˆ‰æª”æ¡ˆé€Ÿåº¦æ¸¬è©¦

```python
import time
from pathlib import Path

# æ¸¬è©¦åˆ—èˆ‰ 7,500 å€‹æª”æ¡ˆ
start = time.time()
files = list(Path('data/temp_markdown').glob('*.md'))
elapsed = time.time() - start

print(f"åˆ—èˆ‰ {len(files)} å€‹æª”æ¡ˆ: {elapsed:.2f} ç§’")
# é æœŸ: macOS ~0.05 ç§’, Windows ~0.2 ç§’
```

**çµè«–**: 7,500 å€‹æª”æ¡ˆçš„åˆ—èˆ‰é€Ÿåº¦å¯æ¥å—,ä½†:
- âŒ Git æ“ä½œæœƒè®Šæ…¢ (git status, git add)
- âŒ å‚™ä»½æ™‚é–“è®Šé•·
- âŒ ç£ç¢Ÿç©ºé–“æµªè²»

---

## å¢é‡æ›´æ–°è¨­è¨ˆ

### JSONL å¢é‡å¯«å…¥

```python
class JSONLHandler:
    def append_items(self, data_type: str, new_items: List[Dict]) -> int:
        """
        è¿½åŠ æ–°è³‡æ–™åˆ° JSONL (å¢é‡æ›´æ–°)

        Args:
            data_type: è³‡æ–™é¡å‹
            new_items: æ–°å¢çš„è³‡æ–™åˆ—è¡¨

        Returns:
            è¿½åŠ çš„ç­†æ•¸
        """
        filepath = self.get_filepath(data_type)

        # æª¢æŸ¥é‡è¤‡ (é€é ID)
        existing_ids = self._get_existing_ids(data_type)

        unique_items = [
            item for item in new_items
            if item.get('id') not in existing_ids
        ]

        # è¿½åŠ å¯«å…¥
        with open(filepath, 'a', encoding='utf-8') as f:
            for item in unique_items:
                f.write(json.dumps(item, ensure_ascii=False) + '\n')

        logger.info(f"è¿½åŠ  {len(unique_items)} ç­†æ–°è³‡æ–™")

        # æ›´æ–°ç´¢å¼•
        self.index_manager.update_index(data_type, unique_items)

        return len(unique_items)
```

### Gemini å¢é‡ä¸Šå‚³

```python
# åªä¸Šå‚³æ–°å¢çš„å…¬å‘Š
def upload_new_announcements(uploader, since_date):
    """
    åªä¸Šå‚³æŒ‡å®šæ—¥æœŸä¹‹å¾Œçš„æ–°å…¬å‘Š

    Args:
        uploader: GeminiUploader å¯¦ä¾‹
        since_date: èµ·å§‹æ—¥æœŸ (ä¾‹å¦‚: '2025-11-01')
    """
    # 1. å¾ JSONL è®€å–æ–°å…¬å‘Š
    handler = JSONLHandler()
    all_items = handler.read_all('announcements')
    new_items = [
        item for item in all_items
        if item.get('date', '') >= since_date
    ]

    logger.info(f"æ‰¾åˆ° {len(new_items)} ç­†æ–°å…¬å‘Š")

    # 2. ç”¢ç”Ÿæ–°å…¬å‘Šçš„ Markdown (æš«å­˜)
    temp_dir = Path('data/temp_markdown_new')
    formatter = BatchMarkdownFormatter()

    for item in new_items:
        md_content = formatter.format_announcement(item)
        filename = f"{item['id']}_{item['title'][:30]}.md"
        filepath = temp_dir / filename

        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(md_content)

    # 3. ä¸Šå‚³ (skip_existing=True æœƒè‡ªå‹•è·³éå·²ä¸Šå‚³çš„)
    stats = uploader.upload_directory(
        str(temp_dir),
        skip_existing=True
    )

    # 4. æ¸…ç†
    shutil.rmtree(temp_dir)

    return stats
```

---

## é‡å»ºç´¢å¼• (åˆ‡æ› Store)

### ä½¿ç”¨æƒ…å¢ƒ

1. åˆ‡æ›åˆ°æ–°çš„ API Key
2. å»ºç«‹æ¸¬è©¦ç’°å¢ƒçš„ Store
3. ç½é›£æ¢å¾© (é‡å»ºæ•´å€‹ Store)

### å¯¦ä½œ

```python
def rebuild_store(
    api_key: str,
    store_name: str,
    delete_old_store: bool = False
):
    """
    å¾ JSONL é‡å»ºæ•´å€‹ Gemini Store

    Args:
        api_key: æ–°çš„ API Key
        store_name: æ–°çš„ Store åç¨±
        delete_old_store: æ˜¯å¦åˆªé™¤èˆŠçš„ Store
    """
    uploader = GeminiUploader(
        api_key=api_key,
        store_name=store_name
    )

    # åˆªé™¤èˆŠ Store (é¸æ“‡æ€§)
    if delete_old_store:
        try:
            uploader.delete_store()
            logger.info("å·²åˆªé™¤èˆŠ Store")
        except:
            pass

    # å¾ JSONL é‡å»º
    temp_dir = Path('data/temp_markdown_rebuild')

    try:
        # 1. ç”¢ç”Ÿæ‰€æœ‰ Markdown
        formatter = BatchMarkdownFormatter()
        result = formatter.format_individual_files(
            data_type='announcements',
            output_dir=str(temp_dir)
        )

        logger.info(f"ç”¢ç”Ÿ {result['created_files']} å€‹æª”æ¡ˆ")

        # 2. å…¨éƒ¨ä¸Šå‚³åˆ°æ–° Store
        stats = uploader.upload_directory(
            str(temp_dir),
            skip_existing=False,  # å…¨éƒ¨é‡æ–°ä¸Šå‚³
            auto_split=False
        )

        logger.info(f"é‡å»ºå®Œæˆ: {stats['uploaded_files']} å€‹æª”æ¡ˆ")

        return stats

    finally:
        # 3. æ¸…ç†æš«å­˜
        if temp_dir.exists():
            shutil.rmtree(temp_dir)
```

---

## ç°¡åŒ–å¾Œçš„ GeminiUploader

### ç§»é™¤ä¸å¿…è¦çš„åŠŸèƒ½

```python
class GeminiUploader:
    """ç°¡åŒ–ç‰ˆ Gemini ä¸Šå‚³å™¨ (é‡å°å€‹åˆ¥æª”æ¡ˆä¸Šå‚³)"""

    def __init__(
        self,
        api_key: Optional[str] = None,
        store_name: Optional[str] = None,
        max_retries: int = 3,
        retry_delay: float = 2.0
    ):
        """
        åˆå§‹åŒ–ä¸Šå‚³å™¨

        Args:
            api_key: Gemini API Key
            store_name: Store åç¨±
            max_retries: æœ€å¤§é‡è©¦æ¬¡æ•¸
            retry_delay: é‡è©¦å»¶é²åŸºæ•¸
        """
        # ç§»é™¤ max_file_size_kb, max_items_per_split (ä¸å†éœ€è¦)
        # ç§»é™¤ temp_dir, split_files (ä¸å†éœ€è¦åˆ†å‰²)

        self.max_retries = max_retries
        self.retry_delay = retry_delay

        # ... å…¶ä»–åˆå§‹åŒ–
```

---

## æœ€çµ‚å»ºè­°

### âœ… æ¡ç”¨æ–¹æ¡ˆ A

1. **ä¸»å„²å­˜**: JSONL (`data/announcements/raw.jsonl`)
2. **æš«å­˜**: Markdown æª”æ¡ˆ (`data/temp_markdown/*.md`)
3. **ä¸Šå‚³**: å¾æš«å­˜ç›®éŒ„ä¸Šå‚³
4. **æ¸…ç†**: ä¸Šå‚³å¾Œåˆªé™¤æš«å­˜ Markdown
5. **é‡å»º**: éš¨æ™‚å¯å¾ JSONL é‡æ–°ç”¢ç”Ÿä¸¦ä¸Šå‚³

### å„ªé»ç¸½çµ

- âœ… åªä¿ç•™ 1 å€‹ JSONL æª”æ¡ˆ (7,500 è¡Œ)
- âœ… é¿å… 7,500 å€‹ Markdown æª”æ¡ˆ
- âœ… ç¯€çœç£ç¢Ÿç©ºé–“ (~75 MB)
- âœ… Git æ“ä½œå¿«é€Ÿ
- âœ… æ”¯æ´å¢é‡æ›´æ–°
- âœ… æ”¯æ´å¤š Store (ä¸åŒ API Key)
- âœ… å¯éš¨æ™‚é‡å»ºç´¢å¼•

### å¯¦ä½œæ¸…å–®

- [ ] ç°¡åŒ– `GeminiUploader` (ç§»é™¤åˆ†å‰²åŠŸèƒ½)
- [ ] å¯¦ä½œ `JSONLHandler.append_items()` (å¢é‡å¯«å…¥)
- [ ] å¯¦ä½œ `upload_to_gemini.py` (å®Œæ•´ä¸Šå‚³æµç¨‹)
- [ ] å¯¦ä½œ `rebuild_store.py` (é‡å»º Store)
- [ ] æ›´æ–°æ–‡æª”

---

## å›ç­”æ‚¨çš„å•é¡Œ

### Q1: ä¸éœ€è¦æ™ºæ…§åˆ†å‰²äº†?
**A**: âœ… æ­£ç¢º!æ‡‰è©²ç§»é™¤åˆ†å‰²åŠŸèƒ½,ç°¡åŒ–ä¸Šå‚³å™¨ã€‚

### Q2: èƒ½å¦ç”¨å¦ä¸€å€‹ API Key é‡å»ºç´¢å¼•?
**A**: âœ… å¯ä»¥!å¾ JSONL é‡æ–°ç”¢ç”Ÿ Markdown â†’ ä¸Šå‚³åˆ°æ–° Store â†’ æ¸…ç†æš«å­˜ã€‚

### Q3: ä¸Šå‚³å¾Œæœƒåˆªé™¤ MD æª”æ¡ˆå—?
**A**: âœ… å»ºè­°åˆªé™¤!Markdown æ˜¯æš«å­˜æ ¼å¼,JSONL æ‰æ˜¯ä¸»å„²å­˜ã€‚é¿å… 7,500 å€‹æª”æ¡ˆæ‹–å®é€Ÿåº¦ã€‚
